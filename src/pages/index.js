import { useState, useEffect } from 'react';
import Head from 'next/head';
import { Container, Typography } from '@mui/material';
import Accordion from '@mui/material/Accordion';
import AccordionSummary from '@mui/material/AccordionSummary';
import AccordionDetails from '@mui/material/AccordionDetails';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import Media from '@/components/Media';

const jikanBaseUrl = 'https://api.jikan.moe/';
const version = 'v4';
const API = `${jikanBaseUrl}${version}`;
const topLimit = 25;
const endpoints = {
    top: '/top/anime',
    search: '/anime',
};

const getAnimeList = data => data.map(item => ({
    id: item.mal_id,
    title: item.title,
    title_japanese: item.title_japanese,
    image: item.images.webp.image_url,
    nrOfEpisodes: item.episodes,
    bookmarked: false,
})) || [];

export default function Home() {
    const [ animeList, setAnimeList ] = useState([]);
    const [ pagination, setPagination ] = useState({});
    const [ isLoading, setLoading ] = useState(false);
    const [ expanded, setExpanded ] = useState('panel1');

    useEffect(() => {
        /* fetch data */
        setLoading(true);
        fetch(`${API}${endpoints.top}`)
            .then((res) => res.json())
            .then((data) => {
                setAnimeList(getAnimeList(data.data));
                setPagination(data.pagination);
                setLoading(false);
            });

    }, []);

    const toggleBookmark = id => {
        const items = [ ...animeList ];
        const item = items.find(item => item.id === id);

        item.bookmarked = !item.bookmarked;

        setAnimeList(items);
    };

    const bookmarkedList = animeList.filter(item => item.bookmarked);

    const handleChange = (panel) => (event, newExpanded) => {
        setExpanded(newExpanded ? panel : false);
    };

    return (
        <>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <main>
                <Container maxWidth="md">
                    <Typography variant="h1" component="h1" gutterBottom>
                        My Anime
                    </Typography>

                    <Accordion expanded={expanded === 'panel1'} onChange={handleChange('panel1')}>
                        <AccordionSummary
                            expandIcon={<ExpandMoreIcon />}
                            aria-controls="panel1a-content"
                            id="panel1a-header"
                            sx={{
                                backgroundColor: 'dark',
                            }}
                        >
                            <Typography variant="h6">
                                Top Anime
                            </Typography>
                        </AccordionSummary>

                        <AccordionDetails>
                            <Media
                                data={animeList}
                                loading={isLoading}
                                limit={topLimit}
                                toggleBookmark={toggleBookmark}
                            />
                        </AccordionDetails>
                    </Accordion>

                    <Accordion expanded={expanded === 'panel2'} onChange={handleChange('panel2')}>
                        <AccordionSummary
                            expandIcon={<ExpandMoreIcon />}
                            aria-controls="panel2a-content"
                            id="panel2a-header"
                            sx={{
                                backgroundColor: 'dark',
                            }}
                        >
                            <Typography variant="h6">
                                Bookmarked
                            </Typography>
                        </AccordionSummary>

                        <AccordionDetails>
                            <Media
                                data={bookmarkedList}
                                loading={false}
                                limit={topLimit}
                                toggleBookmark={toggleBookmark}
                            />
                        </AccordionDetails>
                    </Accordion>
                </Container>
            </main>
        </>
    );
}
